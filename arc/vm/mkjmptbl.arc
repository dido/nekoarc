;; Copyright (C) 2018, 2019 Rafael R. Sevilla
;;
;; This file is part of NekoArc
;;
;; NekoArc is free software; you can redistribute it and/or modify it
;; under the terms of the GNU Lesser General Public License as
;; published by the Free Software Foundation; either version 3 of the
;; License, or (at your option) any later version.
;;
;; This library is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU Lesser General Public License for more details.
;;
;; You should have received a copy of the GNU Lesser General Public
;; License along with this library; if not, see <http://www.gnu.org/licenses/>
;;
;; Generate JmpTbl.java from instructions.arc
;;
(def genjmptbl (inf outf)
  (let itbl (table)
    (w/infile fp inf
      (whilet inst (read fp)
	(let (itype mnemonic opcode . extra) inst
	  (= (itbl opcode)
	     (if (no mnemonic) "NIL"
		 (upcase (coerce mnemonic 'string)))))))
    (w/outfile ofp outf
	       (w/stdout ofp
		 (prn "
/* This file is automatically generated -- DO NOT EDIT! */
package com.stormwyrm.nekoarc;

import com.stormwyrm.nekoarc.vm.INVALID;
import com.stormwyrm.nekoarc.vm.Instruction;
import com.stormwyrm.nekoarc.vm.instruction.*;

public class JmpTbl {
    private static final INVALID NOINST = new INVALID();
    public static final Instruction[] jmptbl = {")
		 (for i 0 255
		      (pr "            ")
		      (aif (itbl i)
			   (prn "new " it "(),        // 0x" (coerce i 'string 16))
			   (prn "NOINST,")))
		 (prn "    };
}")))))

